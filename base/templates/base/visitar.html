{% extends "base/base.html" %}

{% block title %}Museu Luiza Cantofa - Agendamento Interativo{% endblock %}

{% block extra_css %}
<style>
.form-container {
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    max-width: 700px;
    margin: 0 auto 40px auto;
    margin-top: 40px;
}

.form-container h2 {
    text-align: center;
    color: #56070C;
    margin-bottom: 25px;
}

.form-container label {
    font-weight: 500;
    color: #333;
}

.form-container input,
.form-container select,
.form-container button {
    width: 100%;
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-container input:focus,
.form-container select:focus {
    border-color: #56070C;
    outline: none;
    box-shadow: 0 0 5px rgba(86,7,12,0.3);
}

.form-container button {
    background-color: #56070C;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease;
}

.form-container button:hover {
    background-color: #EFB810;
    color: #333;
}

#calendar {
    max-width: 900px;
    margin: 0 auto 50px auto;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 15px;
}

.fc-theme-standard .fc-scrollgrid {
    border: none;
    background-color: #fff;
    border-radius: 10px;
}

.fc-toolbar {
    background-color: #56070C;
    color: white;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
}

.fc-toolbar-title {
    font-size: 1.2rem;
    font-weight: bold;
}

.fc-button {
    background-color: #EFB810 !important;
    border: none !important;
    color: #333 !important;
    font-weight: 600;
    border-radius: 6px !important;
    transition: all 0.3s;
}

.fc-button:hover {
    background-color: #c99b0d !important;
    color: white !important;
}

.fc-event {
    cursor: pointer;
    font-size: 0.9rem;
    text-align: center;
    border-radius: 6px;
    font-weight: 500;
}

.fc-timegrid-slot {
    border-color: #eee;
}

input[readonly] {
    background-color: #e9ecef;
}
</style>
{% endblock %}

{% block content %}
<main class="container my-5">
    <div class="form-container">
        <h2>Agende sua visita ao Museu Luiza Cantofa</h2>
        <form method="post" action="{% url 'visitar' %}" id="form-agendamento">
            {% csrf_token %}

            <label for="telefone">Telefone:</label>
            <input type="tel" id="telefone" name="telefone" required>

            <label for="tipo_visitante">Tipo de Visitante:</label>
            <select name="tipo_visitante" id="tipo_visitante" required>
                <option value="individual">Individual</option>
                <option value="grupo">Grupo de Amigos</option>
                <option value="instituicao">Instituição de Ensino</option>
            </select>

            <div id="campo_instituicao" style="display:none;">
                <label for="instituicao">Nome da Instituição:</label>
                <input type="text" name="instituicao">
            </div>

            <label for="quantidade_visitantes">Quantidade de Visitantes:</label>
            <input type="number" name="quantidade_visitantes" value="1" required>

            <label for="data">Data da Visita:</label>
            <input type="date" name="data" id="data" readonly required>

            <label for="horario">Horário da Visita:</label>
            <input type="time" name="horario" id="horario" readonly required>

            <button type="submit">Agendar Visita</button>
        </form>
    </div>

    <div id="calendar"></div>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

<script>
const horariosManha = ['08:00', '09:00', '10:00', '11:00'];
const horariosTarde = ['13:00', '14:00', '15:00', '16:00'];
const agendamentosOcupados = {{ agendamentos_json|safe }};

function gerarEventos(agendamentos) {
    const eventos = [];
    const hoje = new Date();
    for (let i = 0; i < 7; i++) {
        const data = new Date();
        data.setDate(hoje.getDate() + i);
        const yyyy = data.getFullYear();
        const mm = String(data.getMonth() + 1).padStart(2, '0');
        const dd = String(data.getDate()).padStart(2, '0');
        const strData = `${yyyy}-${mm}-${dd}`;

        [...horariosManha, ...horariosTarde].forEach(horario => {
            const ocupado = agendamentos[strData]?.includes(horario) || false;
            eventos.push({
                title: ocupado ? 'Ocupado' : 'Livre',
                start: `${strData}T${horario}`,
                display: 'block',
                backgroundColor: ocupado ? '#ff4d4d' : '#28a745',
                borderColor: ocupado ? '#ff4d4d' : '#28a745',
                extendedProps: { ocupado },
            });
        });
    }
    return eventos;
}

document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        initialView: 'timeGridWeek',
        allDaySlot: false,
        slotMinTime: "08:00:00",
        slotMaxTime: "17:00:00",
        slotDuration: "01:00:00",
        events: gerarEventos(agendamentosOcupados),
        height: 500,
        eventClick: function(info) {
            if (!info.event.extendedProps.ocupado) {
                document.getElementById('data').value = info.event.startStr.slice(0,10);
                document.getElementById('horario').value = info.event.startStr.slice(11,16);
                window.scrollTo({ top: document.getElementById('form-agendamento').offsetTop, behavior: 'smooth' });
            } else {
                alert('Este horário já está ocupado.');
            }
        }
    });
    calendar.render();
});
</script>
{% endblock %}
